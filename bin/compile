#!/usr/bin/env bash

# The Fly Heroku Buildpack. This script accepts parameters for a build
# directory, a cache directory, and a directory for app environment variables.

# ## Usage:
#
#     $ bin/compile <build-dir> <cache-dir> <env-path>

# Fail fast and fail hard.
set -eo pipefail

BUILD_DIR=$1

mkdir -p $BUILD_DIR/bin
mkdir -p $BUILD_DIR/.profile.d

echo "-----> Installing Fly Agent"
curl -s https://s3.amazonaws.com/flyio-wormhole-builds/latest/pkg/wormhole_linux_amd64 > $BUILD_DIR/bin/wormhole

echo `ls -la $BUILD_DIR/`

echo "-----> Writing .profile.d/fly.sh"
env > $BUILD_DIR/.profile.d/fly.env.sh

# export ENV_DIR env files into one ENV file
env_dir=$3
if [ -d "$env_dir" ]; then
  for e in $(ls $env_dir); do
    echo "$e=$(cat $env_dir/$e)" > $BUILD_DIR/.profile.d/fly.env_dir.sh
  done
fi

cat <<-EOF > $BUILD_DIR/.profile.d/fly.sh
export FLY_PORT=\$PORT
export FLY_RELEASE_ID=$SOURCE_VERSION
export FLY_RELEASE_DESC="`git log -1 --format="%s"`"
export FLY_RELEASE_BRANCH=\${FLY_RELEASE_BRANCH:-master}
\$HOME/bin/wormhole &
EOF
